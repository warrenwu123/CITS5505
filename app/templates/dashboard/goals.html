{% extends 'dashboard/layout.html' %}

{% set active_page = 'goals' %}

{% block dashboard_title %}Your Goals{% endblock %}

{% block dashboard_content %}


<!-- Current Goals -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center bg-gradient">
                <h6 class="m-0 fw-bold text-white"><i class="fas fa-history me-2"></i>Current Activity Sessions</h6>
                <button type="button" class="btn btn-light pulse-button" data-bs-toggle="modal" data-bs-target="#createGoalModal">
                    <i class="fas fa-plus me-2 text-primary"></i> New Session
                </button>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="goalSelector" class="form-label text-light">Select Goal</label>
                    <select class="form-select" id="goalSelector">
                        <option value="" selected disabled>Choose a goal</option>
                            {% for goal in goals %}
                            <option value="goal-{{ goal.id }}">Goal {{ goal.id }} </option>
                            {% endfor %}
                    </select>
                    <div id="goalCount" data-count="{{ goals|length }}"></div>
                </div>
            </div>

            {% if sessions|length == 0 %}
            <div class="text-center py-5 empty-state">
                <i class="fas fa-dumbbell fa-4x mb-4 text-secondary opacity-50"></i>
                <h5 class="text-secondary">No Activity Sessions Yet</h5>
                <p class="mb-4 text-muted">Track your workouts by creating a new session.</p>
                <button type="button" class="btn btn-primary pulse-button" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                    <i class="fas fa-plus me-2"></i> Create Your First Session
                </button>
            </div>
        {% else %}
        <div id="goalCardsContainer" class="mt-3 d-flex flex-nowrap overflow-auto">
            {% for goal in goals %}
            <div class="goal-card card shadow-sm flex-shrink-0" data-goal-id="{{ goal.id }}" style="width: 200px; margin-right: 15px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-light">
                            Goal {{ goal.id }}
                        </h6>
                        <button class="btn btn-sm btn-danger delete-goal-btn" data-goal-id="{{ goal.id }}" title="Delete Goal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
            {% for goal in goals %}   
            <div class="goal-type-container mb-4" data-goal-id="{{ goal.id }}" {% if not loop.first %} style="display:none"{% endif %}>
                <div class="goal-type-header d-flex justify-content-between align-items-center">
                    <h4 class="goal-title mb-0">
                        {% if goal.goal_type.name == 'weightloss' %}
                            <i class="fas fa-weight scale-in-center text-danger me-2"></i>
                        {% elif goal.goal_type.name == 'weightgain' %}
                            <i class="fas fa-dumbbell scale-in-center text-success me-2"></i>
                        {% elif goal.goal_type.name == 'strength' %}
                            <i class="fas fa-fist-raised scale-in-center text-warning me-2"></i>
                        {% elif goal.goal_type.name == 'endurance' %}
                            <i class="fas fa-child scale-in-center text-info me-2"></i>
                        {% else %}
                            <i class="fas fa-running scale-in-center text-primary me-2"></i>
                        {% endif %}
                        <span class="text-uppercase">{{ goal.goal_type.name }}</span>
                    </h4>
                    <span class="badge bg-primary rounded-pill">{{ goal.activity_sessions|length }} sessions</span>
                </div>
                <div class="sessions-grid mt-3">
                    {% for session in goal.activity_sessions %}
                        <div class="activity-card activity-{{ session.activity_type.name|lower }}" data-session-id="{{ session.id }}">
                            <div class="activity-header">
                                <div class="activity-icon">
                                    {% if session.activity_type.name|lower == 'running' %}
                                        <i class="fas fa-running"></i>
                                    {% elif session.activity_type.name|lower == 'walking' %}
                                        <i class="fas fa-walking"></i>
                                    {% elif session.activity_type.name|lower == 'cycling' %}
                                        <i class="fas fa-biking"></i>
                                    {% elif session.activity_type.name|lower == 'swimming' %}
                                        <i class="fas fa-swimmer"></i>
                                    {% elif session.activity_type.name|lower == 'yoga' %}
                                        <i class="fas fa-pray"></i>
                                    {% elif session.activity_type.name|lower == 'gym' %}
                                        <i class="fas fa-dumbbell"></i>
                                    {% else %}
                                        <i class="fas fa-heartbeat"></i>
                                    {% endif %}
                                </div>
                                <h5 class="activity-title">{{ session.activity_type.name }}</h5>
                                <div class="completion-badge {{ 'completed' if session.is_completed else 'pending' }}">
                                    {{ 'Completed' if session.is_completed else 'Pending' }}
                                </div>
                            </div>
    
                            <div class="activity-details">
                              
                                    {% set endurance_activities = ['Running', 'Walking', 'Cycling', 'Swimming'] %}
                                    {% set strength_activities = ['Barbell Squat', 'Bench Press', 'Deadlift', 'Chin-up', 'Military Press', 'Push-up'] %}
                                
                                    {% if session.activity_type.name in endurance_activities %}
                                        {% set per_round = 30 %}
                                    {% elif session.activity_type.name in strength_activities %}
                                        {% set per_round = 10 %}
                                    {% else %}
                                        {% set per_round = 1 %}
                                    {% endif %}
                                
                                    {% set rounds = (session.duration // per_round) if per_round > 0 else 0 %}
                                
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-sync-alt text-warning me-1"></i> Rounds:</span>
                                        <span class="detail-value text-light">{{ rounds }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-clock text-light me-1"></i> Duration per round:</span>
                                        <span id="roundtime" class="detail-value text-light">{{ per_round }} minutes</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-hourglass-half text-info me-1"></i> Time Left:</span>
                                        <span id="timeLeft" class="detail-value text-light" data-default="{{ per_round }}" data-session-id="{{ session.id }}">{{ per_round }} minutes</span>
                                    </div>
                     
    
                                {% set name = session.activity_type.name.lower() %}
                                {% if name in ['running', 'walking', 'cycling', 'swimming'] %}
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-fire text-danger me-1"></i> Calories:</span>
                                        <span class="detail-value calories text-light">{{ session.calories_burned or 'N/A' }}</span>
                                    </div>
                                {% elif name in ['barbell squat', 'bench press', 'deadlift', 'chin-up', 'military press', 'push-up'] %}
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-layer-group text-info me-1"></i> Sets:</span>
                                        <span class="detail-value">{{ session.sets or 'N/A' }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label text-light"><i class="fas fa-redo text-success me-1"></i> Reps:</span>
                                        <span class="detail-value" id="reps">{{ session.reps or 'N/A' }}</span>
                                    </div>
                                {% endif %}
                            </div>
    
                            <div class="activity-actions">
                                {% if not session.is_completed %}
                                    <button class="btn btn-sm btn-success complete-session-btn" data-session-id="{{ session.id }}">
                                        <i class="fas fa-check me-1"></i> Complete
                                    </button>
                                {% endif %}
                                <button class="btn btn-sm btn-info text-white edit-session-btn" data-session-id="{{ session.id }}" data-activity-name="{{ session.activity_type.name }}" data-bs-target="#editGoalModal" data-bs-toggle="modal" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-session-btn" data-session-id="{{ session.id }}" data-bs-target="#deleteGoalModal" data-bs-toggle="modal" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}     
                </div>
                </div>  
            {% endfor %}
        {% endif %}


<!-- Goal Insights -->
<div class="row">
    <!-- Goal Distribution -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goals by Activity Type</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie">
                    <canvas id="goalDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Goal Completion Rate -->
    <div class="col-xl-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Goal Completion History</h6>
            </div>
            <div class="card-body">
                <div class="chart-bar">
                    <canvas id="goalCompletionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Goal Modal -->
<div class="modal fade" id="createGoalModal" tabindex="-1" aria-labelledby="createGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-light" id="createGoalModalLabel">Create New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createGoalForm">
                    <!-- Activity Type -->
                    <!-- <div class="mb-3">
                        <label for="activityType" class="form-label text-light">Activity Type</label>
                        <select class="form-select" id="activityType" required>
                            <option value="" selected disabled>Select activity type</option>
                            {% for activity_type in activity_types %}
                            <option value="{{ activity_type.id }}">{{ activity_type.name }}</option>
                            {% endfor %}
                        </select>   
                        <div class="form-text">
                            Choose the type of physical activity you plan to focus on.
                        </div>
                    </div> -->

                    <!-- Goal Type -->
                    <div class="mb-3">
                        <label for="goalType" class="form-label text-light">Goal Type</label>
                        <select class="form-select" id="goalType" required>
                            <option value="" selected disabled>Select goal type</option>
                            <option value="weightloss">Weight Loss</option>
                            <option value="weightgain">Weight Gain</option>
                            <option value="strength">Strength</option>
                            <option value="endurance">Endurance</option>
                        </select>
                        <div class="form-text">
                            What kind of outcome do you want to achieve through your training?
                        </div>
                    </div>

                    <!-- Target Value (conditionally visible) -->
                    <div class="mb-3" id="targetValueGroup" style="display: none;">
                        <label for="targetValue" class="form-label text-light">Target Value</label>
                        <input type="number" class="form-control" id="targetValue" min="1" step="0.01">
                        <div class="form-text" id="targetValueHelp">
                            Enter your target body weight (in kg or lbs) or the amount of weight to lose or gain.
                        </div>
                    </div>

                    <!-- Fitness Level -->
                    <div class="mb-3">
                        <label for="fitnessLevel" class="form-label text-light">Fitness Level</label>
                        <select class="form-select" id="fitnessLevel" required>
                            <option value="" selected disabled>Select your current fitness level</option>
                            <option value="beginner">Beginner</option>
                            <option value="novice">Novice</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="elite">Elite</option>
                        </select>
                        <div class="form-text">
                            Helps tailor your goal based on your experience level and physical conditioning.
                        </div>
                    </div>

                    <!-- Available Time Per Week -->
                    <div class="mb-3">
                        <label for="availableTime" class="form-label text-light">Available Time Per Week (in hours)</label>
                        <input type="number" class="form-control" id="availableTime" min="1" max="168" step="0.5" required>
                        <div class="form-text">
                            How many hours can you dedicate to training per week? (Helps personalize recommendations)
                        </div>
                    </div>

                    <!-- End Date -->
                    <div class="mb-3">
                        <label for="endDate" class="form-label text-light">End Date (Optional)</label>
                        <input type="date" class="form-control" id="endDate">
                        <div class="form-text">
                            Leave empty if this is an ongoing goal with no specific end date.
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGoalBtn">Create Goal</button>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-labelledby="editGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGoalModalLabel">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm">
                    <input type="hidden" id="editGoalId">
                    <div class="mb-3" id="editRepsGroup">
                        <label for="editReps" class="form-label">Reps</label>
                        <input type="number" class="form-control" id="editReps" min="1">
                    </div>
                    <div class="mb-3" id="editSetsGroup">
                        <label for="editSets" class="form-label">Sets</label>
                        <input type="number" class="form-control" id="editSets" min="1">
                    </div>
                    <div class="mb-3" id="editTimeGroup">
                        <label for="editDuration" class="form-label">Time (minutes)</label>
                        <input type="number" class="form-control" id="editDuration" min="1">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateGoalBtn">Update Goal</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<!-- Delete Goal Confirmation Modal -->
<div class="modal fade" id="deleteGoalModal" tabindex="-1" aria-labelledby="deleteGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteGoalModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Goal</button>
            </div>
        </div>
    </div>
</div>

<!-- Countdown Timer Modal -->
<div class="modal fade" id="countdownModal" tabindex="-1" aria-labelledby="countdownModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="countdownModalLabel">Activity Countdown</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="countdown-display mb-4">
                    <h1 class="display-1" id="countdownTimer">00:00:00</h1>
                    <p class="lead" id="activityNameDisplay"></p>
                </div>
                <div class="progress mb-4">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                         role="progressbar" style="width: 100%"></div>
                </div>
                <div class="controls">
                    <button id="startCountdownBtn" class="btn btn-success me-2">
                        <i class="fas fa-play me-1"></i> Start
                    </button>
                    <button id="pauseCountdownBtn" class="btn btn-warning me-2" disabled>
                        <i class="fas fa-pause me-1"></i> Pause
                    </button>
                    <button id="resumeCountdownBtn" class="btn btn-info" disabled>
                        <i class="fas fa-redo me-1"></i> Resume
                    </button>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="completeSessionBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-check me-1"></i> Complete Session
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    // Global variables
let deleteGoalId = null;
let distributionChart = null;
let existingGoalsCount = parseInt(document.getElementById('goalCount').dataset.count);
    
document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('saveGoalBtn').addEventListener('click', createGoal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteGoal);
        setupDeleteGoalButtons();

    // Highlight the first goal card by default if exists
        const firstGoalCard = document.querySelector('.goal-card');
        if (firstGoalCard) {
                const firstGoalId = firstGoalCard.getAttribute('data-goal-id');
                firstGoalCard.classList.add('border-primary', 'shadow-lg');
                firstGoalCard.style.border = '2px solid #007bff';
                document.getElementById('goalSelector').value = `goal-${firstGoalId}`;
            }
       
        
        const timeLeftElem = document.getElementById('timeLeft');
        const sessionId = timeLeftElem.dataset.sessionId;
        const defaultTime = parseInt(timeLeftElem.dataset.default);
        const storageKey = `timeLeft-session-${sessionId}`;
        const storedTime = localStorage.getItem(storageKey);

        if (storedTime) {
        const [h = 0, m = 0, s = 0] = storedTime.split(':').map(Number);
        const totalMinutes = h * 60 + m;
        timeLeftElem.textContent = `${totalMinutes} minutes ${s} seconds`;
        } else {
        timeLeftElem.textContent = `${defaultTime} minutes 0 seconds`;
}});


    document.getElementById('goalType').addEventListener('change', function () {
    const selected = this.value;
    const targetGroup = document.getElementById('targetValueGroup');
    if (selected === 'weightloss' || selected === 'weightgain') {
        targetGroup.style.display = 'block';
    } else {
        targetGroup.style.display = 'none';
    }
});

    
document.querySelectorAll('.edit-session-btn').forEach(button => {
    button.addEventListener('click', function () {
        const sessionId = this.getAttribute('data-session-id');
        const activityName = this.getAttribute('data-activity-name')?.toLowerCase() || "";

        document.getElementById('editGoalId').value = sessionId;

       
        const cardioTypes = ['running', 'walking', 'cycling', 'swimming'];
        const strengthTypes = ['barbell squat', 'bench press', 'deadlift', 'chin-up', 'military press', 'push-up'];

       
        document.getElementById('editTimeGroup').style.display = 'none';
        document.getElementById('editRepsGroup').style.display = 'none';
        document.getElementById('editSetsGroup').style.display = 'none';

      
        if (cardioTypes.includes(activityName)) {
            document.getElementById('editTimeGroup').style.display = 'block';
        } else if (strengthTypes.includes(activityName)) {
            document.getElementById('editRepsGroup').style.display = 'block';
            document.getElementById('editSetsGroup').style.display = 'block';
        }

        
    });
});

document.getElementById('updateGoalBtn').addEventListener('click', async () => {
    const sessionId = document.getElementById('editGoalId').value;
    const reps = document.getElementById('editRepsGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editReps').value) 
        : null;

    const sets = document.getElementById('editSetsGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editSets').value) 
        : null;

    const duration = document.getElementById('editTimeGroup').style.display !== 'none' 
        ? parseInt(document.getElementById('editDuration').value) 
        : null;

  
    const updateData = {
        session_id: sessionId,
        reps: reps,
        sets: sets,
        duration: duration
    };
    console.log(updateData, "updateData")

    try {
        const response = await fetch('/dashboard/api/update-goal-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });

        if (response.ok) {
            const result = await response.json();
            
            alert('Goal updated successfully!');
            location.reload();  
        } else {
            const error = await response.json();
            alert(`Update failed: ${error.message}`);
        }
    } catch (err) {
        console.error('Error updating goal:', err);
        alert('An error occurred while updating the goal.');
    }
});


document.getElementById('goalSelector').addEventListener('change', function() {
const selectedGoalId = this.value ? this.value.split('-')[1] : null;
        
        // Remove highlight from all goal cards
        document.querySelectorAll('.goal-card').forEach(card => {
            card.classList.remove('border-primary', 'shadow-lg');
            card.style.border = '';
        });

        // Highlight selected goal card
        if (selectedGoalId) {
            const selectedCard = document.querySelector(`.goal-card[data-goal-id="${selectedGoalId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('border-primary', 'shadow-lg');
                selectedCard.style.border = '2px solid #007bff';
            }
        }

        // Existing goalSelector change logic
    document.querySelectorAll('.goal-type-container').forEach(container => {
            container.style.display = 'none';
        });
        
        if (selectedGoalId && this.value !== '') {
            const container = document.querySelector(`.goal-type-container[data-goal-id="${selectedGoalId}"]`);
            if (container) {
                container.style.display = 'block';
            }
        } else {
            document.querySelectorAll('.goal-type-container').forEach((container, index) => {
                container.style.display = index === 0 ? 'block' : 'none';
            });
        }
    
    
    //     const GoalId = this.value;
        
    
    //     document.querySelectorAll('.goal-type-container').forEach(container => {
    //         container.style.display = 'none';
    //     });
        
    
        // if (GoalId && GoalId !== '') {
        //     selectedGoalId = GoalId.split('-')[1];
        //     const container = document.querySelector(`.goal-type-container[data-goal-id="${selectedGoalId}"]`);
        //     if (container) {
        //         container.style.display = 'block';
        //     }
        // } else {
            
        //     document.querySelectorAll('.goal-type-container').forEach((container, index) => {
        //         container.style.display = index === 0 ? 'block' : 'none';
        //     });
        // }
    });


document.addEventListener('DOMContentLoaded', function() {
    const firstGoal = document.querySelector('.goal-type-container');
    if (firstGoal) {
        firstGoal.style.display = 'block';
    }
});

// document.getElementById("deleteAllGoalsBtn").addEventListener("click", async () => {
//     if (!confirm("Are you sure you want to delete ALL goals? This action cannot be undone!")) return;

//     try {
//         const response = await fetch("/dashboard/api/goals/delete_all", {
//             method: "DELETE"
//         });

//         if (response.ok) {
//             const result = await response.json();
//             alert(result.message);
//             window.location.reload();
//         } else {
//             const error = await response.json();
//             alert("Error: " + error.error);
//         }
//     } catch (err) {
//         alert("Request failed. Please try again.");
//         console.error(err);
//     }
// });

// let deleteSessionId = null;

function setupDeleteGoalButtons() {
    document.querySelectorAll('.delete-goal-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const goal_id = this.getAttribute('data-goal-id');
            if (!confirm(`Are you sure you want to delete Goal #${goal_id}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/dashboard/api/goals/delete/${goal_id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log(response, "response")

                if (response.ok) {
                    alert('Goal deleted successfully!');
                    window.location.reload(); // Reload to update UI
                } else {
                    const error = await response.json();
                    alert(`Error deleting goal: ${error.message}`);
                }
            } catch (err) {
                console.error('Error deleting goal:', err);
                alert('An error occurred while deleting the goal.');
            }
        });
    });
}
    


    function formatDateTime(isoString) {
        const dt = new Date(isoString);
        return dt.toLocaleString();
    }

    function formatDuration(durationStr) {
        try {
            const duration = JSON.parse(durationStr);
            const minutes = duration?.seconds ? Math.floor(duration.seconds / 60) : 0;
            return `${minutes} minutes`;
        } catch {
            return 'N/A';
        }
    }


document.getElementById('goalSelector').addEventListener('change', async function () {
    const distributionChartElem = document.getElementById('goalDistributionChart');
    const selectedValue = this.value; 
    const goalId = selectedValue.split('-')[1];  

  
    if (distributionChartElem) {
        try {
            const res = await fetch(`/dashboard/api/session_distribution?goal_id=${goalId}`);
            const result = await res.json();
            console.log(result, "result")
            

            if (distributionChart) {
            distributionChart.destroy();
         }

            distributionChart = new Chart(distributionChartElem, {
                type: 'doughnut',
                data: {
                    labels: result.labels,
                    datasets: [{
                        data: result.data,
                        backgroundColor: [
                            '#FF6B6B', '#48DBFB', '#1DD1A1', '#54A0FF', '#C56CF0', '#FF9F43', '#00d2d3', '#576574'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        } catch (err) {
            console.error('Failed to load session distribution:', err);
        }
    }
})


async function createGoal() {
        if (existingGoalsCount >= 3) {
        alert("❗In order to ensure the training effect, you can have up to three goals at a time.");
        return;
    }
    // const activityTypeId = document.getElementById('activityType').value;
    const goalType = document.getElementById('goalType').value;
    const targetValue = document.getElementById('targetValue').value;
    const fitnessLevel = document.getElementById('fitnessLevel').value;
    const availableTime = document.getElementById('availableTime').value;
    const endDate = document.getElementById('endDate').value;

    if (!goalType || !fitnessLevel || !availableTime) {
        alert('Please fill in all required fields');
        return;
    }

    const goalData = {
        // activity_type_id: parseInt(activityTypeId),
        goal_type: goalType,
        target_value: (goalType === 'weightloss' || goalType === 'weightgain') ? parseFloat(targetValue) : null,
        fitness_level: fitnessLevel,
        available_time_per_week: parseFloat(availableTime),
        end_date: endDate || null
    };
    console.log(goalData,"goalData")
    console.log(goalData.goal_type,"goalData.goal_type")

    if (goalData.goal_type === 'weightloss' && goalData.end_date) {
        const totalTargetCalories = goalData.target_value * 7700;

        const today = new Date();
        const end = new Date(goalData.end_date);

        const diffTime = end - today;
        const weeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7)) + 1;

        const maxBurnPerWeek = goalData.available_time_per_week * 700; // kcal per week
        const totalPossibleCalories = maxBurnPerWeek * weeks;

        console.log(`Target: ${totalTargetCalories}, Possible: ${totalPossibleCalories}`);

        if (totalTargetCalories > totalPossibleCalories) {
            alert("❗You can't lose that much weight within this timeline. Please reset your goal (increase available time and/or end date, or reduce target value).");
            return; // Stop execution
        }
    }
      

    try {
        const response = await fetch('/dashboard/api/create-goal', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(goalData)
        });
        // const text = await response.text();  
        // console.log('Raw response:', text); 

        if (response.ok) {
            const result = await response.json();
        } else {
            const error = await response.json();
            alert(`Error creating goal: ${error.error}`);
        }
    } catch (error) {
        console.error('Error creating goal:', error);
        alert('Error creating goal. Please try again.');
    }
}
    
    
async function deleteGoal() {
        if (!deleteSessionId) return;
        
        try {
            const response = await fetch(`/dashboard/api/sessions/${deleteSessionId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Reload the page to update the goals list
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error deleting goal: ${error.error}`);
            }
        } catch (error) {
            console.error('Error deleting goal:', error);
            alert('Error deleting goal. Please try again.');
        }
    }
    // Countdown Timer Variables
    let countdownInterval;
    let remainingSeconds = 0;
    let isPaused = false;
    let currentSessionId = null;
    let initialDuration = 0;

    // Setup complete session buttons
    document.querySelectorAll('.complete-session-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentSessionId = this.getAttribute('data-session-id');
            const sessionCard = this.closest('.activity-card');
            const durationText = sessionCard.querySelector('#timeLeft')?.textContent || '0';
            console.log(durationText, "durationText")
            
            // Parse duration (assuming format like "30 minutes" or "1 hour 30 minutes")
            initialDuration = parseFormattedDurationToSeconds(durationText) 
            remainingSeconds = initialDuration;
            
            console.log(remainingSeconds, "remainingSeconds")
            // Set activity name
            const activityName = sessionCard.querySelector('.activity-title').textContent;
            document.getElementById('activityNameDisplay').textContent = activityName;
            
            // Reset UI
            document.getElementById('countdownTimer').textContent = formatTime(remainingSeconds);
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('startCountdownBtn').disabled = false;
            document.getElementById('pauseCountdownBtn').disabled = true;
            document.getElementById('resumeCountdownBtn').disabled = true;
            document.getElementById('completeSessionBtn').disabled = true;
            
            // Show modal
            const countdownModal = new bootstrap.Modal(document.getElementById('countdownModal'));
            countdownModal.show();
        });
    });

    // Countdown control buttons
    document.getElementById('startCountdownBtn').addEventListener('click', startCountdown);
    document.getElementById('pauseCountdownBtn').addEventListener('click', pauseCountdown);
    document.getElementById('resumeCountdownBtn').addEventListener('click', resumeCountdown);
    document.getElementById('completeSessionBtn').addEventListener('click', completeSession);

    function parseFormattedDurationToSeconds(text) {
    const minutesMatch = text.match(/(\d+)\s*minutes?/);
    const secondsMatch = text.match(/(\d+)\s*seconds?/);

    const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
    const seconds = secondsMatch ? parseInt(secondsMatch[1]) : 0;

    return minutes * 60 + seconds;
}

    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function startCountdown() {
        clearInterval(countdownInterval);
        isPaused = false;
        
        document.getElementById('startCountdownBtn').disabled = true;
        document.getElementById('pauseCountdownBtn').disabled = false;
        document.getElementById('completeSessionBtn').disabled = false;
        
        countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown(); // Update immediately
    }

    function pauseCountdown() {
        clearInterval(countdownInterval);
        isPaused = true;
        document.getElementById('pauseCountdownBtn').disabled = true;
        document.getElementById('resumeCountdownBtn').disabled = false;
    }

    function resumeCountdown() {
        isPaused = false;
        document.getElementById('pauseCountdownBtn').disabled = false;
        document.getElementById('resumeCountdownBtn').disabled = true;
        countdownInterval = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
        remainingSeconds--;
        document.getElementById('countdownTimer').textContent = formatTime(remainingSeconds);
        
        // Update progress bar
        const progressPercent = (remainingSeconds / initialDuration) * 100;
        document.getElementById('progressBar').style.width = `${progressPercent}%`;
        
        if (remainingSeconds <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('countdownTimer').textContent = "COMPLETED!";
            document.getElementById('progressBar').classList.remove('bg-success');
            document.getElementById('progressBar').classList.add('bg-primary');
            document.getElementById('pauseCountdownBtn').disabled = true;
            document.getElementById('resumeCountdownBtn').disabled = true;
            document.getElementById('completeSessionBtn').disabled = false;
        }
    }

async function completeSession() {
    const enduranceActivities = ['running', 'walking', 'cycling', 'swimming'];
    const strengthActivities = ['barbell squat', 'bench press', 'deadlift', 'chin-up', 'military press', 'push-up'];

    const activityName = document.getElementById('activityNameDisplay').textContent.trim().toLowerCase();
    const countdownText = document.getElementById('countdownTimer').textContent.trim();

    const [hours, minutes, seconds] = countdownText.split(':').map(Number);
    const totalSeconds = hours * 3600 + minutes * 60 + seconds;

    const sessionId = document.getElementById('timeLeft')?.dataset.sessionId;
    const storageKey = `timeLeft-session-${sessionId}`;
    const perRoundElem = document.getElementById('roundtime');
    const perRound = parseInt(perRoundElem.textContent) || 0;

    console.log(totalSeconds, "totalSeconds")
    console.log(sessionId, "sessionId")
    console.log(storageKey, "storageKey")
    console.log(perRound, "perRound")

    if (strengthActivities.includes(activityName)) {
        if (totalSeconds > 0) { 
            alert("You should complete ten minutes of training continuously.");
            return;
        }
        const repsElement = document.getElementById('reps');
        const actualReps = parseInt(repsElement?.textContent.trim()) || 0;
        await recordSessionProcess({
            type: 'strength',
            sessionId: sessionId,
            actualDuration: perRound,
            actualReps: actualReps
        });
        await finishSessionAPI(sessionId, perRound);

    } else if (enduranceActivities.includes(activityName)) {
        const perRoundElem = document.getElementById('roundtime');
        const perRound = parseInt(perRoundElem.textContent) || 0;

        if (totalSeconds > 0) {
            await recordSessionProcess({
                type: 'endurance',
                sessionId: sessionId,
                actualDuration: perRound - totalSeconds
            });
            // ⏱️ Store timeLeft in localStorage instead of updating text directly
            if (storageKey) {
                localStorage.setItem(storageKey, countdownText);
            }
        } else {
            await finishSessionAPI(sessionId, perRound);
        }

    } else {
        await finishSessionAPI(sessionId, perRound);
    }

    const modalElement = document.getElementById('countdownModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
        modalInstance.hide();
    }
}

async function recordSessionProcess({ type, sessionId, actualDuration, actualReps = null }) {
    const payload = {
        session_id: sessionId,
        actual_duration: actualDuration
    };

    if (type === 'strength' && actualReps !== null) {
        payload.actual_reps = actualReps;
    }

    try {
        const response = await fetch('/dashboard/api/sessions/record_process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
            console.error("Error recording session process:", result.message || result.error);
        } else {
            console.log("Recorded session process:", result.message);
        }
    } catch (error) {
        console.error("Failed to record session process:", error);
    }
}

async function finishSessionAPI(sessionId, perRound) {
    try {
        const response = await fetch(`/dashboard/api/sessions/${sessionId}/complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ per_round: perRound })
        });

        if (response.ok) {
        
            const key = `timeLeft-session-${sessionId}`;
            localStorage.removeItem(key);
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Error completing session: ${error.message}`);
        }
    } catch (err) {
        console.error('Error completing session:', err);
        alert('Error completing session. Please try again.');
    }
}
    
</script>
{% endblock %}